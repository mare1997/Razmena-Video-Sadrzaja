$(document).ready(function(){
	var id = window.location.search.slice(1).split('&')[0].split('=')[1];
	var video=$('#videoPlayer');
	var videoName=$('#videoName');
	var videoViews=$('#videoViews');
	var LIDdiv=$('#LandDBtn')
	var userName=$('#authorName');
	var date=$('#videoDate');
	var description=$('#textDesc');
	var comms=$('.commentRow');
	var commLDBtnGroup=$('.commLDBtnGroup');
	var addComms=$('#myComment');
	var submitComm=$('#myCommBtn');
	var contentComm=$('#myCommentText');
	var options=$('#options');
	
	$.get('VideoServlet',{'id':id},function(data){
		if(data.status == 'blocked'){
			console.log("usao  u blok ");
			$('.mainDiv').hide();
			blockInfo();
		}
		
		video.attr("src","https://www.youtube.com/embed/"+data.video.url+"?rel=0&autoplay=1");
		videoName.text(data.video.name);
		videoViews.text(data.video.previews);
		LIDdiv.append('<button type="button" id="likeBtn" class="btn btn-danger"><span class="glyphicon glyphicon-thumbs-up"></span>'+ data.video.numberOfLikes +'</button>'+
                '<button type="button" id="dislikeBtn" class="btn btn-default"><span class="glyphicon glyphicon-thumbs-down"></span>'+ data.video.numberOfDislikes +'</button>');
		userName.text(data.video.owner.username);
		userName.attr('href','user.html?username='+data.video.owner.username);
		date.text(format(data.video.date));
		description.text(data.video.description);
		var userImg=document.getElementById("authorPic")
		userImg.setAttribute('src','./pictures/'+ data.video.owner.id +'.jpg');
		var author=document.getElementById("author")
		author.setAttribute('href','user.html?username='+ data.video.owner.username);
		var isSubs=data.isSubscribed;
		var subNumber=data.subNumber;
		comms.empty();
		for(i in data.comments){
			comms.append(
					'<div class="col-md-12 col-sm-12" id="comm'+ data.comments[i].id +'">'+
						'<div class="thumbnail" id="comment">'+
							'<a href="user.html?username='+ data.comments[i].owner.username +'" id="commentOwner">'+ data.comments[i].owner.username  +'</a>'+
							'<p id="commentDate">'+format(data.comments[i].date)+'</p>'+
							'<div class="commentText">'+
							'<p id="'+ data.comments[i].id +'">'+data.comments[i].content+'</p>'+
						'</div>'+
						
						'<div class="btn-group" id="'+ data.comments[i].id +'c">'+
						'<button type="button" class="btn btn-danger" id="likeBtnComm'+ data.comments[i].id +'" onclick="likeComm('+ data.comments[i].id +')"><span class="glyphicon glyphicon-thumbs-up"></span>'+ data.comments[i].likeNumber +'</button>'+
						'<button type="button" class="btn btn-default" id="dislikeBtnComm'+ data.comments[i].id +'" onclick="dislikeComm('+ data.comments[i].id +')"><span class="glyphicon glyphicon-thumbs-down"></span> '+ data.comments[i].dislikeNumber +'</button>'+
					'</div></div></div>'
					);
			if(data.user != null){
			if((data.comments[i].owner.username == data.user.username && data.user.blocked == false) || data.user.role == "ADMIN"){
				var commLDB=$("#" + data.comments[i].id+"c");
				commLDB.append(
						'<button type="button" class="dropdown-toggle btn btn-default" data-toggle="dropdown" id="optionsForAdminOrOwners"><span class="glyphicon glyphicon-menu-hamburger"></span></button>'+
	                    '<ul class="dropdown-menu" >'+
	                        '<li id="deleteCom"><a href="#deleteModalComm" data-toggle="modal" data-book-id="'+ data.comments[i].id +'">Delete comment</a></li>'+
	                        '<li id="editCom"><a href="#editCommModal" data-toggle="modal" data-book-id="'+ data.comments[i].id +'">Edit comment</a></li>'+
	                    '</ul>'
						);
			}
			}
		}
			if(data.user != null){
 				var y = document.getElementById("navBarNotLogIn");
 		    	y.style.display = "none";
 		    	var y = document.getElementById("navBarLogIn");
 		    	y.style.display = "block";
 		    	var userPage =document.getElementById("userPage");
 	 		    userPage.setAttribute('href','user.html?username='+ data.user.username);
 	 		    var adminPage =$("#adminPage");
 	 		    if(data.user.role != "ADMIN"){
 	 		    	adminPage.hide();
 	 		    }
 	 		    $("#loggeduser").text(data.user.username)
 				}	else{
 				var y = document.getElementById("navBarNotLogIn");
 		    	y.style.display = "block";
 		    	var y = document.getElementById("navBarLogIn");
 		    	y.style.display = "none";
 			}
			if(data.video.blocked == true || data.video.owner.blocked == true){
				if(data.user!= null){
					if(data.user.username == data.video.owner.username || data.user.role == "ADMIN"){
						
					}else {
						$("#loginErrorMessage").text("Blocked!");
						$("#loginErrorMessage").text("Video or owner of video are blocked!");
						$("#closeLoginFaild").attr('onclick','block()');
	                    $("#badLoginModal").modal();
					}
				}
			}
			if(data.video.allowComments == false && data.user.username != data.video.owner.username && data.user.role != "ADMIN" ){
				$(".commDiv").hide();
			}
			if(data.video.allowRating == false && data.user.username != data.video.owner.username && data.user.role != "ADMIN"){
				LIDdiv.hide();
			}
			if (data.status == "visiter" || data.user.blocked == true){
				addComms.hide();
				
			}
			if(data.user == null){
					$('#subButton').on('click',function(event){
						$("#exampleModalLabel").text("Sub!");
						$("#deleteBody").text("You must sign in first!");
						$("#deleteBtn").text('OK')
						$("#deleteModal").modal();
						$("#cancel").hide();
						$('#deleteBtn').on('click',function(event){
							$("#deleteModal").modal("toggle");
							
						});
						event.preventDefault();
						return false;
					});
					$('#likeBtn').on('click',function(event){
						$("#exampleModalLabel").text("Like!");
						$("#deleteBody").text("You must sign in first!");
						$("#deleteBtn").text('OK')
						$("#deleteModal").modal();
						$("#cancel").hide();
						$('#deleteBtn').on('click',function(event){
							$("#deleteModal").modal("toggle");
							
						});
						event.preventDefault();
						return false;
					});
					$('#dislikeBtn').on('click',function(event){
						$("#exampleModalLabel").text("Like!");
						$("#deleteBody").text("You must sign in first!");
						$("#deleteBtn").text('OK')
						$("#deleteModal").modal();
						$("#cancel").hide();
						$('#deleteBtn').on('click',function(event){
							$("#deleteModal").modal("toggle");
							
						});
						event.preventDefault();
						return false;
					});
					$('#likeBtnComm').on('click',function(event){
						$("#exampleModalLabel").text("Like!");
						$("#deleteBody").text("You must sign in first!");
						$("#deleteBtn").text('OK')
						$("#deleteModal").modal();
						$("#cancel").hide();
						$('#deleteBtn').on('click',function(event){
							$("#deleteModal").modal("toggle");
							
						});
						event.preventDefault();
						return false;
					});
					$('#dislikeBtnComm').on('click',function(event){
						$("#exampleModalLabel").text("Like!");
						$("#deleteBody").text("You must sign in first!");
						$("#deleteBtn").text('OK')
						$("#deleteModal").modal();
						$("#cancel").hide();
						$('#deleteBtn').on('click',function(event){
							$("#deleteModal").modal("toggle");
							
						});
						event.preventDefault();
						return false;
					});
					
				}
			if(data.user!= null){
				if(data.user.role == 'ADMIN'){
					
					$('#options').append(
							'<button type="button" class="dropdown-toggle btn btn-default" data-toggle="dropdown" id="optionsForAdminOrOwners"><span class="glyphicon glyphicon-menu-hamburger"></span></button>'+
							'<ul class="dropdown-menu" id="optionsForOwnerAndAdmin">'+
							'<li id="editVideo"><a href="#editVideoModal" data-toggle="modal">Edit video</a></li>'+
							'<li id="deleteVideo"><a href="#deleteModal" data-toggle="modal">Delete video</a></li>'+
			                '<li id="blockVideo"><a href="#blockModal" data-toggle="modal">Block video</a></li>'+
			                
	               	'</ul>'
					);
				}
				if(data.user.id == data.video.owner.id && data.user.blocked == false){
					
					$('#options').append(
							'<button type="button" class="dropdown-toggle btn btn-default" data-toggle="dropdown" id="optionsForAdminOrOwners"><span class="glyphicon glyphicon-menu-hamburger"></span></button>'+
							'<ul class="dropdown-menu" id="optionsForOwnerAndAdmin">'+
							'<li id="editVideo"><a href="#editVideoModal" data-toggle="modal">Edit video</a></li>'+
			                '<li id="deleteVideo"><a href="#deleteModal" data-toggle="modal">Delete video</a></li>'+
			                
	               	'</ul>'
					);
				}
				if(data.video.allowComments == true && data.user.blocked == false){
					addComms.show();
					submitComm.on('click',function(event){
						var content=contentComm.val();
						$.post('CommentServlet',{'content':content,'owner':data.user.username,'video':data.video.id,'status': "add"},function(data){
							if(data.status=="success"){
								comms.append('<div class="col-md-12 col-sm-12" id="comm'+ data.id +'">'+
										'<div class="thumbnail" id="comment">'+
										'<a href="user.html" id="commentOwner">'+ data.owner  +'</a>'+
										'<p id="commentDate">'+format(data.date)+'</p>'+
										'<div class="commentText">'+
										'<p id="'+ data.id +'" >'+data.content+'</p>'+
									'</div>'+
									
									'<div class="btn-group" id="commLDBtnGroup">'+
									'<button type="button" class="btn btn-danger" id="likeBtnComm'+ data.id +'" onclick="likeComm('+ data.id +')"><span class="glyphicon glyphicon-thumbs-up"></span>'+ data.likeNumber +'</button>'+
									'<button type="button" class="btn btn-default" id="dislikeBtnComm'+ data.id +'" onclick="dislikeComm('+ data.id +')"><span class="glyphicon glyphicon-thumbs-down"></span> '+ data.dislikeNumber +'</button>'+
									'<button type="button" class="dropdown-toggle btn btn-default" data-toggle="dropdown" id="optionsForAdminOrOwners"><span class="glyphicon glyphicon-menu-hamburger"></span></button>'+
			                        '<ul class="dropdown-menu" >'+
			                            '<li><a href="#deleteModalComm" data-toggle="modal" id="deleteCom"  data-book-id="'+ data.id +'">Delete comment</a></li>'+
			                            '<li><a href="#editCommModal" data-toggle="modal"  id="editCom" data-book-id="'+ data.id +'">Edit comment</a></li>'+
			                        '</ul>'+
								'</div></div></div>');
								
							}
							contentComm.val("")
						});
						event.preventDefault();
						return false;
					});
				}
				if(data.user.blocked == false){
					$('#deleteModalComm').on('show.bs.modal',function(event){
						 var bookId = $(event.relatedTarget).data('book-id');
						 document.getElementById("deleteModalCommBtn").setAttribute("name", bookId);
						 
					});
					$('#editCommModal').on('show.bs.modal',function(event){
						var bookId = $(event.relatedTarget).data('book-id');
						document.getElementById("editCommModalbtn").setAttribute("name", bookId);
						
					});
					$('#deleteModalCommBtn').on('click',function(event){
						var idd=$(this).attr('name');
						$.post('CommentServlet',{'id':idd,'status':"delete"},function(data){
							if(data.stat == "success"){
								$("#comm"+idd).remove();
								$("#deleteModalComm").modal('toggle');
							}
						});
						
						event.preventDefault();
						return false;
					});
					$('#editCommModalbtn').on('click',function(event){
						var content=$('#editComm').val();
						var idd=$(this).attr('name');
						$.post('CommentServlet',{'id':idd,'status':"edit",'content':content},function(data){
							if(data.stat == "success"){
								$("#"+ idd).text(content);
								$("#editCommModal").modal('toggle');

							}
						});
						event.preventDefault();
						return false;
						
						
					});
					
					
					$('#likeBtn').on('click',function(event){
						
						$.get('LikeVideoServlet',{'id':data.video.id},function(data){
							
							$('#likeBtn').html('<span class="glyphicon glyphicon-thumbs-up"></span>' + data.likeNumber)
							$('#dislikeBtn').html('<span class="glyphicon glyphicon-thumbs-down"></span> ' + data.dislikeNumber)	
						});
							
							event.preventDefault();
							return false;
						});
					$('#dislikeBtn').on('click',function(event){
						
						$.post('LikeVideoServlet',{'id':data.video.id},function(data){
							$('#likeBtn').html('<span class="glyphicon glyphicon-thumbs-up"></span>' + data.likeNumber)
							$('#dislikeBtn').html('<span class="glyphicon glyphicon-thumbs-down"></span> ' + data.dislikeNumber)	
						});
							
							event.preventDefault();
							return false;
						});
					$('#editVideo').on('click',function(event){
						var visibility=$('#visibility').val();
				    	var allowComments=$('#allowComments').val();
				    	var allowRating=$('#allowRating').val();
				    	var description=$('#description').val();
				    	var params={
				    			'id':id,
								'visibility':visibility,
								'allowComments':allowComments,
								'allowRating':allowRating,
								'description':description,
								'status':'edit'
							};
				    	$.post('VideoServlet',params,function(data){
							if(data.status=="success"){
								location.reload();
							}
						});
						event.preventDefault();
						return false;
					});
					$('#deleteBtn').on('click',function(event){
						$.post('VideoServlet',{'videoId':id,'status':"delete"},function(data){
							window.location.replace('index.html');
				    	});
				    	event.preventDefault();
						return false;
					});
					$('#blockbtn').on('click',function(event){
						$.post('VideoServlet',{'videoId':id,'status':"block"},function(data){
							window.location.replace('index.html');
							
				    	});
				    	event.preventDefault();
						return false;
					});
					$('#order').on('click',function(event){
				    	var desc=$('#desc');
				    	var asc=$('#asc');
				    	var column=$('#orderVideos').val();
				    	var ascDesc=asc.val();
						if(desc.is(':checked')){
							var ascDesc=desc.val();
						}
						$.post('CommentServlet',{'status':"order",'column':column,'ascDesc':ascDesc,'videoId':id},function(data){
							if(data.stat == "success"){
								comms.empty();
								for(i in data.comments){
								comms.append(
										'<div class="col-md-12 col-sm-12" id="comm'+ data.comments[i].id +'">'+
											'<div class="thumbnail" id="comment">'+
												'<a href="user.html?username='+ data.comments[i].owner.username +'" id="commentOwner">'+ data.comments[i].owner.username  +'</a>'+
												'<p id="commentDate">'+format(data.comments[i].date)+'</p>'+
												'<div class="commentText">'+
												'<p id="'+ data.comments[i].id +'">'+data.comments[i].content+'</p>'+
											'</div>'+
											
											'<div class="btn-group" id="commLDBtnGroup">'+
											'<button type="button" class="btn btn-danger" id="likeBtnComm'+ data.comments[i].id +'" onclick="likeComm('+ data.comments[i].id +')"><span class="glyphicon glyphicon-thumbs-up"></span>'+ data.comments[i].likeNumber +'</button>'+
											'<button type="button" class="btn btn-default" id="dislikeBtnComm'+ data.comments[i].id +'" onclick="dislikeComm('+ data.comments[i].id +')"><span class="glyphicon glyphicon-thumbs-down"></span> '+ data.comments[i].dislikeNumber +'</button>'+
										'</div></div></div>'
										);
								if(data.user != null){
								if((data.comments[i].owner.username == data.user.username && data.user.blocked == false) || data.user.role == "ADMIN"){
									var commLDB=$("#commLDBtnGroup");
									commLDB.append(
											'<button type="button" class="dropdown-toggle btn btn-default" data-toggle="dropdown" id="optionsForAdminOrOwners"><span class="glyphicon glyphicon-menu-hamburger"></span></button>'+
					                        '<ul class="dropdown-menu" >'+
					                            '<li id="deleteCom"><a href="#deleteModalComm" data-toggle="modal" data-book-id="'+ data.comments[i].id +'">Delete comment</a></li>'+
					                            '<li id="editCom"><a href="#editCommModal" data-toggle="modal" data-book-id="'+ data.comments[i].id +'">Edit comment</a></li>'+
					                        '</ul>'
											);
								}
								}
							}
							}
						});
						event.preventDefault();
						return false;
				    	
				    });
					
					if(isSubs == "subscribe"){
			    		 $("#subButton").text("Subscribed " + subNumber );
				         $("#subButton").attr('class', 'btn btn-default');
					}else{
						 $("#subButton").text("Subscribe " + subNumber );
			             $("#subButton").attr('class', 'btn btn-danger');
					}
			    	if(data.user.username != data.video.owner.username){
			    		$("#subButton").on('click',function(event){
			    			if(isSubs == "unsuscribed"){
								$.post('SubscribeServlet',{'channel':data.video.owner.username,'subscriber':data.user.username},function(data){
									if(data.status == "success"){
										$("#subButton").text("Subscribed " + data.subN);
							            $("#subButton").attr('class', 'btn btn-default');
							            isSubs = "subscribe";
									}
									
								});
			    				}else{
			    					$.get('SubscribeServlet',{'channel':data.video.owner.username,'subscriber':data.user.username,},function(data){
				    					if(data.status == "success"){
											$("#subButton").text("Subscribe "+ data.subN);
								            $("#subButton").attr('class', 'btn btn-danger');
								            isSubs = "unsuscribed";
										}
										
									});
									event.preventDefault();
									return false;
				    				
				    			
			    				}
								event.preventDefault();
								return false;
							});
			    	}
					
				}
			}
		});
});
function likeComm(cid){
	console.log(cid)
	$.get('LikeCommentServlet',{'id':cid},function(data){
			var v= $('#commLDBtnGroup');
			$('#likeBtnComm'+cid).html('<span class="glyphicon glyphicon-thumbs-up"></span>' + data.likeNumber)
			$('#dislikeBtnComm'+cid).html('<span class="glyphicon glyphicon-thumbs-down"></span> ' + data.dislikeNumber)
			});
}




function dislikeComm(cid){
	console.log(cid)
	$.post('LikeCommentServlet',{'id':cid},function(data){
			var v= $('#commLDBtnGroup');
			$('#likeBtnComm'+cid).html('<span class="glyphicon glyphicon-thumbs-up"></span>' + data.likeNumber)
			$('#dislikeBtnComm'+cid).html('<span class="glyphicon glyphicon-thumbs-down"></span> ' + data.dislikeNumber)
		});
}

function block(){
	window.location.replace('index.html');
}
function blockInfo(){
	$("#loginErrorHeader").text("Blocked!");
	$("#loginErrorMessage").text("Video or owner of video are blocked!");
	$("#closeLoginFaild").attr('onclick','block()');
        $("#badLoginModal").modal();
}
function format(tempDate) {
	var date = new Date(tempDate);
	var day = date.getDate();
	var monthIndex = date.getMonth();
	var year = date.getFullYear();
	var monthNames = [
		  "January", "February", "March",
		  "April", "May", "June", "July",
		  "August", "September", "October",
		  "November", "December"
		];
	
	return day + '. ' + monthNames[monthIndex] + ' ' + year+'.';
}